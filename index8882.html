<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>沪深行情 - 增强版</title>
    <style>
        /* 新增状态提示样式 */
        .status-alert {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            color: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .success {
            background: #28a745;
        }
        .error {
            background: #dc3545;
        }
        /* 原有样式保持不变 */
    </style>
</head>
<body>
    <!-- 在页面顶部添加状态提示容器 -->
    <div id="statusMessage" class="status-alert"></div>

    <!-- 原有设置面板和内容保持不变 -->

<script>
// 使用腾讯财经API（支持跨域）
const API_ENDPOINT = 'https://qt.gtimg.cn/q=';

// 显示状态消息的函数
function showStatus(message, isSuccess) {
    const statusEl = document.getElementById('statusMessage');
    statusEl.textContent = message;
    statusEl.className = `status-alert ${isSuccess ? 'success' : 'error'}`;
    statusEl.style.opacity = '1';
    
    setTimeout(() => {
        statusEl.style.opacity = '0';
    }, 3000);
}

// 改进的API请求函数
async function fetchStockData(codes) {
    try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 5000);

        const response = await fetch(`${API_ENDPOINT}${codes.join(',')}`, {
            signal: controller.signal
        });
        clearTimeout(timeoutId);

        if (!response.ok) throw new Error(`HTTP错误! 状态码: ${response.status}`);

        const data = await response.text();
        const result = parseResponseData(data);
        
        showStatus('数据获取成功', true);
        return result;

    } catch (error) {
        const errorMsg = error.name === 'AbortError' ? '请求超时' : `获取失败: ${error.message}`;
        showStatus(errorMsg, false);
        return null;
    }
}

// 解析腾讯财经数据格式
function parseResponseData(data) {
    const pattern = /v_(\w+)="([^"]+)"/g;
    const stocks = {};

    let match;
    while ((match = pattern.exec(data)) !== null) {
        const [_, symbol, params] = match;
        const fields = params.split('~');
        
        stocks[symbol] = {
            name: fields[1],
            price: fields[3],
            change: fields[4],
            changePercent: fields[5]
        };
    }
    
    if (Object.keys(stocks).length === 0) {
        throw new Error('无效的响应数据格式');
    }
    return stocks;
}

// 修改后的数据更新函数
async function updateStockData() {
    const codes = ['sh000001', 'sz399001']; // 上证指数和深证成指
    const stockData = await fetchStockData(codes);
    
    if (!stockData) return;

    // 更新表格逻辑（保持原有实现）
    // ...
}

// 初始化定时器
setInterval(updateStockData, 5000);
updateStockData(); // 立即执行首次请求

/* 原有其他函数保持不变 */
</script>
</body>
</html>